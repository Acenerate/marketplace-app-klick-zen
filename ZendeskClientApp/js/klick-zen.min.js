"use strict";var client,API_URL,OAUTH_URL,OAUTH_NAM,user,ActionTypes,vm;{client=ZAFClient.init();API_URL="https%3A%2F%2F"+window.location.hostname;OAUTH_URL="";OAUTH_NAM="zdg-klick-zen";const t="Request failed with status code 401",o="Request failed with status code 428";ActionTypes={UpdateField:1,SetStatus:2,AddPrivateComment:3,AddPublicComment:4,AddTag:5};const u=window.location.host.indexOf("local.")!==-1;u&&console.clear();axios.defaults.headers.common.Authorization=initVars().JwtToken;axios.defaults.headers.common.Identifier=initVars().custObj.AccessGUID;Vue.component("multiselect",window.VueMultiselect.default);vm=new Vue({el:"#app",data:{appName:"Klick-Zen",V_DISABLED:0,V_LITE:1,V_TRIALFULL:2,V_FULL:3,defaultScreen:"listButtons",FullVersionURL:"https://www.zendesk.com/apps/support/klick-zen/",globalTrackingEnabled:!1,cust:JSON.parse(JSON.stringify(initVars().custObj)),thisExecutionMode:initVars().executionMode,thisFreeVersionLimit:initVars().FreeVersionLimit,hasUsedTrialVersion:initVars().hasUsedTrial,auth:initVars().PreCheckAuth,agreeTOS:!1,agreeFreeTrial:!0,showPostApprove:!1,isFullVersion:null,userIsAdmin:!1,ticketLocked:!1,showSection:"splash",dataUnchanged:!0,editMode:!1,editModeDataChanged:!1,viewSaving:!1,viewGoodSave:!1,viewBadSave:!1,badSaveMessage:"There was an issue with your request",validCreateButtonForm:!1,validSettings:!1,buttons:[],newButton:{},availableTicketFields:[],defaultButtonTemplate:{Name:"Blank Button",AccessGuid:"",Active:!0,Enabled:!0,ReturnURL:"",BorderColor:"#666666",BackgroundColor:"#cccccc",Text:"Button Text",TextColor:"#000099",TextFont:"Arial",TextBold:!1,TextItalic:!1,Radius:10,Actions:[]},genericButtonTemplates:[{Name:"Generic Button",AccessGuid:"",Active:!0,Enabled:!0,ReturnURL:"",BorderColor:"#666666",BackgroundColor:"#cccccc",Text:"Button Text",TextColor:"#000099",TextFont:"Arial",TextBold:!1,TextItalic:!1,Radius:10,Actions:[]},{Name:"Solve Ticket",AccessGuid:"",Active:!0,Enabled:!0,Description:"Solves the ticket",ReturnURL:"",BorderColor:"#666666",BackgroundColor:"#006c00",Text:"Solve Ticket",TextColor:"#ffffff",TextFont:"Arial",TextBold:!1,TextItalic:!1,Radius:10,Actions:[{ActionType:ActionTypes.SetStatus,ActionTarget:null,ActionValue:"solved",Active:!0},{ActionType:ActionTypes.AddPrivateComment,ActionTarget:null,ActionValue:"Ticket was marked as solved by the customer",Active:!0}]},{Name:"Urgent Request",AccessGuid:"",Active:!0,Enabled:!0,Description:"A customer has an urgent request that needs attention",ReturnURL:"",BorderColor:"#666666",BackgroundColor:"#ff0000",Text:"Urgent!",TextColor:"#ffffff",TextFont:"Arial",TextBold:!0,TextItalic:!1,Radius:10,Actions:[{ActionType:ActionTypes.UpdateField,ActionTarget:"360009119054",ActionValue:"Urgent",Active:!0},{ActionType:ActionTypes.AddPublicComment,ActionTarget:null,ActionValue:"This is urgent please help immediately",Active:!0}]},{Name:"Spanish Language",AccessGuid:"",Active:!0,Enabled:!0,Description:"This customer requests to be communicated with in Spanish",ReturnURL:"",BorderColor:"#666666",BackgroundColor:"#0000ff",Text:"EspaÃ±ol",TextColor:"#ffffff",TextFont:"Arial",TextBold:!0,TextItalic:!1,Radius:10,Actions:[{ActionType:ActionTypes.AddTag,ActionTarget:null,ActionValue:"spanish",Active:!0},{ActionType:ActionTypes.AddPrivateComment,ActionTarget:null,ActionValue:"Customer has requested to be communicated with in Spanish",Active:!0}]}]},methods:{doAuth:function(){vm.showPostApprove=!0;var n={};n.ZendeskUserID=user.id;n.Name=user.name;n.Email=user.email;n.HasUsedTrial=vm.agreeFreeTrial;client.context().then(function(t){OAUTH_URL=t.account.subdomain;n.APIRoot=OAUTH_URL;var i=JSON.stringify(n);window.location.href="https://"+OAUTH_URL+".zendesk.com/oauth/authorizations/new?response_type=code&redirect_uri="+API_URL+"%2Fauth%2FZendesk_Decision&client_id="+OAUTH_NAM+"&scope=read%20write&state="+i})},doShowSection:function(n){vm.auth?vm.editMode===!0?Swal.fire({title:"Exit editing without saving changes?",showCancelButton:!0,animation:!1,allowOutsideClick:!1,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"OK"}).then(t=>{t.value&&(this.editMode=!1,vm.showSection=n)}):vm.showSection=n:vm.showSection="authorize"},doTrial:function(){vm.viewSaving=!0;axios.post("/functions/KlickZenTrial.ashx").then(function(t){t.data.activated===!0?(i(vm),s(vm)):n(vm)}).catch(function(i){r(i.message);n(vm,i.message===t)})},saveCustomerData:function(u){vm.dataUnchanged||(vm.viewSaving=!0,axios.post("/functions/KlickZenCustomer.ashx",vm.cust).then(function(){vm.cust_RESET=JSON.parse(JSON.stringify(vm.cust));e(vm,!0);i(vm,u)}).catch(function(i){r(i.message);i.message===o?(vm.viewSaving=!1,Swal.fire({title:"",html:"<b>Your DNS entries did not successfully validate<\/b><br/><br/>Please ensure that you have properly updated your DNS records and try again",timer:7e3,animation:!1})):n(vm,i.message===t)}))},cancelCustomerData:function(){vm.dataUnchanged?vm.showSection=vm.defaultScreen:Swal.fire({title:"Exit editing without saving changes?",showCancelButton:!0,animation:!1,allowOutsideClick:!1,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"OK"}).then(n=>{n.value&&(this.editMode=!1,vm.dataUnchanged||(vm.cust=JSON.parse(JSON.stringify(vm.cust_RESET))),vm.showSection=vm.defaultScreen,e(vm,!0))})},resetDefault:function(){vm.cust.DefaultButton=JSON.parse(JSON.stringify(vm.defaultButtonTemplate))},startButtonCreate:function(n){if(vm.thisExecutionMode===vm.V_LITE&&vm.buttons.length>=initVars().FreeVersionLimit){Swal.fire({title:"",html:"You have reached the maximum amount of buttons available in the free version of Klick-Zen",timer:5e3,animation:!1});return}vm.newButton=n?JSON.parse(JSON.stringify(n)):JSON.parse(JSON.stringify(vm.cust.DefaultButton));vm.newButton.AccessGuid&&(vm.newButton.Name+=" - copy");vm.newButton.AccessGuid="";vm.doShowSection("makeButton");vm.editMode=!0;window.setTimeout(function(){document.getElementById("txtButtonName").select();vm.editModeDataChanged=n?!0:!1},100)},buttonSave:function(){vm.viewSaving=!0;axios.post("/functions/KlickZenButton.ashx",vm.newButton).then(function(){vm.editMode=!1;f();vm.doShowSection("listButtons");i(vm)}).catch(function(i){r(i.message);n(vm,i.message===t)})},cancelButtonCreate:function(){vm.editModeDataChanged?Swal.fire({title:"Exit editing without saving changes?",showCancelButton:!0,animation:!1,allowOutsideClick:!1,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"OK"}).then(n=>{n.value&&(this.editMode=!1,this.doShowSection("listButtons"))}):(this.editMode=!1,this.doShowSection("listButtons"))},uploadImage:function(t){var i=t.target.files,r;i[0]&&(i[0].size>3145728?n(vm,!1):(r=new FileReader,r.readAsDataURL(i[0]),r.onload=n=>{vm.cust.DefaultLandingPage.Logo=n.target.result}))},addButtonAction:function(){this.newButton.Actions.length<6&&this.newButton.Actions.push({ActionType:"",ActionTarget:"",ActionValue:"",Active:!0})},addActionDisabled:function(){return this.newButton.Actions.length>=6||this.newButton.Actions.some(n=>n.ActionType&&!n.ActionValue)},removeButtonAction:function(n){this.newButton.Actions=arrayRemove(this.newButton.Actions,n)},editButton:function(n){vm.newButton=JSON.parse(JSON.stringify(n));vm.doShowSection("makeButton");vm.editMode=!0;window.setTimeout(function(){vm.editModeDataChanged=!1},100)},removeButton:function(n){Swal.fire({title:'Permanently remove button "'+n.Name+'"?',showCancelButton:!0,animation:!1,allowOutsideClick:!1,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"OK"}).then(t=>{t.value&&(vm.newButton=n,vm.newButton.Active=!1,vm.buttonSave())})},actionValueTitle:function(n){let t="";switch(n){case ActionTypes.UpdateField:t="New Field Value";break;case ActionTypes.SetStatus:t="New Status";break;case ActionTypes.AddPrivateComment:t="Comment";break;case ActionTypes.AddPublicComment:t="Comment";break;case ActionTypes.AddTag:t="Tag Name"}return t},fullButtonPlaceholderText:function(n){let t=vm.customDomainToUse();return t="https://"+t+"/","<a href='"+t+"ext/href/"+n.AccessGuid+"/{{ticket.id}}/{{ticket.requester.id}}/{{ticket.created_at_with_timestamp}}'><img src='"+t+"ext/src/"+n.AccessGuid+"/{{ticket.id}}' /><\/a>"},customDomainToUse:function(){return vm.cust_RESET.CustomCNameDomain===""?window.location.hostname:vm.cust.CustomCNameDomain},previewButtonStyle:function(n){var t="color:"+n.TextColor+";";t+="background-color:"+n.BackgroundColor+";";t+="border-radius:"+n.Radius+"px;";t+="border: 2px solid "+n.BorderColor+";";t+="font-family: "+n.TextFont+";";t+="font-style: "+(n.TextItalic?"italic":"normal")+";";t+="font-weight: "+(n.TextBold?"bold":"normal")+";";let i=n.Text.length+8;return i=i<12?12:i,t+("width: "+i+"ch;")},overlayColor:function(n){return n.length<5&&(n+=n.slice(1)),n.length===6&&(n="#"+n),n.replace("#","0x")>15658734?"#333":"#fff"},spaceClean:function(n){return n?n.replace(/ /g,"_").toLowerCase():""}},watch:{cust:{handler:function(){this.dataUnchanged=!1;this.validSettings=(this.cust.DefaultPostActionURL===""||this.cust.DefaultPostActionURL.isValidURL())&&(this.customDomainIsValid||this.cust.CustomCNameDomain==="")},deep:!0},newButton:{handler:function(){this.editModeDataChanged=!0;this.validCreateButtonForm=this.newButton.Name!==""&&this.newButton.Text!==""&&(this.newButton.ReturnURL===""||this.newButton.ReturnURL.isValidURL())&&this.newButton.Actions.find(n=>n.ActionType)},deep:!0}},computed:{enabledButtons:function(){return this.buttons.filter(n=>n.Enabled)},customDomainTLD:function(){let n=this.cust.CustomCNameDomain.split("."),i="",t=n.length;return t>=2&&(i=n[t-2]+"."+n[t-1]),i},customDomainIsValid:function(){let n=this.cust.CustomCNameDomain.split(".");if(n.length>2&&!n.includes(undefined)&&!n.some(n=>n.includes(":")||n.includes("/"))){let n=tldjs.parse(this.cust.CustomCNameDomain);return n.isValid&&!n.isIp&&n.subdomain!==""&&n.tldExists}return!1}},mounted:function(){this.cust_RESET=JSON.parse(JSON.stringify(this.cust))}}).$mount("#app");client.metadata().then(function(n){let t=n.appId.toString();t===initVars().useageA||t===initVars().useageB?(vm.isFullVersion=!0,vm.thisExecutionMode=vm.V_FULL):vm.isFullVersion=!1;client.get("currentUser").then(function(n){user=n.currentUser;vm.userIsAdmin=user.role==="admin"||user.role==="owner";f();vm.doShowSection(vm.defaultScreen);window.setTimeout(function(){var n=document.createElement("style");n.type="text/css";n.innerHTML=".popSection { display: inline }";document.getElementsByTagName("head")[0].appendChild(n)},100)});client.request({url:"/api/v2/ticket_fields.json",type:"GET"}).then(n=>{for(let n of n.ticket_fields)n.active&&n.title!=="Status"&&n.title!=="Subject"&&n.title!=="Description"&&vm.availableTicketFields.push({id:n.id,title:n.title})})});function f(){return new Promise((n,t)=>{axios.get("/functions/KlickZenListButtons.ashx").then(function(t){vm.buttons=t.data.length?t.data:[];n(t)}).catch(function(n){t(n)})})}function h(n,t){window.setTimeout(function(){n.showSection=t},100)}function e(n,t){window.setTimeout(function(){n.dataUnchanged=t},100)}function i(n,t){t=t||!1;n.viewSaving=!1;n.viewGoodSave=!0;var i=2e3;window.setTimeout(function(){n.viewGoodSave=!1},i);t&&window.setTimeout(function(){n.showSection=n.defaultScreen},i+1)}function n(n,t){t=t||!1;n.viewSaving=!1;n.viewBadSave=!0;window.setTimeout(function(){t?window.location.reload(!0):n.viewBadSave=!1},2e3)}function s(n){window.setTimeout(function(){n.thisExecutionMode=n.V_TRIALFULL;n.doShowSection("trialComplete")},1200)}function r(n){u?console.log(n):axios.post("/functions/KlickZenLog.ashx",JSON.stringify({Text:n})).then(function(){}).catch(function(){})}}